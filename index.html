<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ecfdf5">
    <meta name="description" content="Aplikasi catatan premium dengan fitur coding dan keuangan">
    
    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Me Note">

    <title>Me Note Premium</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons (Phosphor Icons) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#ecfdf5',
                            100: '#d1fae5',
                            200: '#a7f3d0',
                            300: '#6ee7b7',
                            400: '#34d399',
                            500: '#10b981',
                            600: '#059669',
                            700: '#047857',
                            800: '#065f46',
                            900: '#064e3b',
                        }
                    },
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        mono: ['"Fira Code"', 'monospace'],
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }
        
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .glass {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .path {
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: draw 2.5s ease-in-out forwards;
        }

        @keyframes draw {
            to { stroke-dashoffset: 0; }
        }

        .fade-out {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.8s ease;
        }

        /* Offline Indicator Style */
        #offline-badge {
            transform: translateY(-100%);
            transition: transform 0.3s ease-in-out;
        }
        #offline-badge.show {
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-brand-50 text-gray-800 font-sans h-screen flex flex-col overflow-hidden">

    <!-- OFFLINE INDICATOR (NEW) -->
    <div id="offline-badge" class="fixed top-0 left-0 right-0 bg-gray-800 text-white text-xs font-bold text-center py-2 z-[60] shadow-md flex items-center justify-center gap-2">
        <i class="ph ph-wifi-slash text-lg"></i>
        <span>Mode Offline - Perubahan tersimpan di perangkat</span>
    </div>

    <!-- LANDING SCREEN -->
    <div id="landing-screen" class="fixed inset-0 z-50 bg-brand-50 flex flex-col items-center justify-center">
        <div class="relative w-32 h-32 mb-6">
            <svg class="w-full h-full text-brand-600 drop-shadow-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path class="path" d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                <rect class="path" x="8" y="2" width="8" height="4" rx="1" ry="1" style="animation-delay: 0.5s"></rect>
                <path class="path" d="M9 14h6" style="animation-delay: 1s"></path>
                <path class="path" d="M9 18h6" style="animation-delay: 1.2s"></path>
                <path class="path" d="M9 10h6" style="animation-delay: 1.4s"></path>
            </svg>
        </div>
        <h1 class="text-2xl font-bold text-brand-800 tracking-tight animate-pulse">Me Note Premium</h1>
        <p class="text-brand-600 mt-2 text-sm">Organize Your Life</p>
    </div>

    <!-- MAIN APP CONTENT -->
    <main id="app-container" class="flex-1 overflow-y-auto no-scrollbar pb-32 pt-6 px-5 opacity-0 transition-opacity duration-700">
        
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div>
                <p class="text-xs font-bold text-brand-500 uppercase tracking-widest mb-1">Selamat Datang</p>
                <h2 class="text-3xl font-bold text-gray-900" id="header-title">Catatan</h2>
            </div>
            <div class="w-10 h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-brand-600">
                <i class="ph ph-user text-xl"></i>
            </div>
        </header>

        <!-- VIEW: NOTES (DEFAULT) -->
        <div id="view-notes" class="view-section space-y-4">
            <div onclick="openModal('note')" class="bg-white rounded-2xl p-4 shadow-sm border border-brand-100 flex items-center gap-4 cursor-pointer active:scale-[0.98] transition-all group">
                <div class="w-12 h-12 rounded-xl bg-brand-100 text-brand-600 flex items-center justify-center group-hover:bg-brand-600 group-hover:text-white transition-colors">
                    <i class="ph ph-plus text-2xl"></i>
                </div>
                <div>
                    <h3 class="font-bold text-gray-800">Buat Catatan Baru</h3>
                    <p class="text-sm text-gray-400">Tulis ide atau tugas harian</p>
                </div>
            </div>
            <div id="notes-list" class="grid gap-3"></div>
        </div>

        <!-- VIEW: CODE -->
        <div id="view-code" class="view-section hidden space-y-4">
            <div onclick="openModal('code')" class="bg-gray-900 rounded-2xl p-4 shadow-lg shadow-gray-200 cursor-pointer active:scale-[0.98] transition-all group relative overflow-hidden">
                <div class="absolute top-0 right-0 p-3 opacity-10">
                    <i class="ph ph-code text-6xl text-white"></i>
                </div>
                <div class="flex items-center gap-4 relative z-10">
                    <div class="w-12 h-12 rounded-xl bg-gray-800 text-brand-400 flex items-center justify-center border border-gray-700">
                        <i class="ph ph-brackets-curly text-2xl"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-white">Simpan Snippet</h3>
                        <p class="text-sm text-gray-400">Python, JS, HTML, dll.</p>
                    </div>
                </div>
            </div>
            <div id="code-list" class="space-y-4"></div>
        </div>

        <!-- VIEW: EXPENSES -->
        <div id="view-expenses" class="view-section hidden space-y-6">
            <div class="bg-gradient-to-br from-brand-600 to-brand-800 rounded-3xl p-6 text-white shadow-xl shadow-brand-200 relative overflow-hidden">
                <div class="absolute -top-10 -right-10 w-40 h-40 bg-white opacity-10 rounded-full blur-3xl"></div>
                <p class="text-brand-100 text-sm font-medium mb-1">Total Pengeluaran</p>
                <h3 id="total-expense" class="text-3xl font-bold tracking-tight">Rp 0</h3>
                <div class="mt-6 flex gap-2">
                    <button onclick="openModal('expense')" class="flex-1 bg-white/20 backdrop-blur-sm py-2 rounded-xl text-sm font-medium hover:bg-white/30 transition">
                        + Tambah
                    </button>
                    <button onclick="resetExpenses()" class="w-10 bg-white/10 backdrop-blur-sm rounded-xl flex items-center justify-center hover:bg-red-500/50 transition">
                        <i class="ph ph-trash"></i>
                    </button>
                </div>
            </div>
            <div>
                <div class="flex justify-between items-center mb-3 px-1">
                    <h4 class="font-bold text-gray-700">Riwayat Belanja</h4>
                    <span class="text-xs text-gray-400 bg-white px-2 py-1 rounded-lg border">Bulan Ini</span>
                </div>
                <div id="expense-list" class="space-y-2"></div>
            </div>
        </div>
    </main>

    <!-- FLOATING NAVIGATION -->
    <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-md z-40">
        <div class="glass rounded-3xl p-2 shadow-2xl shadow-brand-900/10 flex justify-between items-center px-6">
            <button onclick="switchTab('notes')" class="nav-btn active flex flex-col items-center gap-1 p-2 rounded-xl transition-all w-16" data-tab="notes">
                <i class="ph ph-notepad text-2xl mb-0.5"></i>
                <span class="text-[9px] font-bold">Notes</span>
            </button>
            <button onclick="switchTab('code')" class="nav-btn flex flex-col items-center gap-1 p-2 rounded-xl transition-all w-16 text-gray-400" data-tab="code">
                <i class="ph ph-code text-2xl mb-0.5"></i>
                <span class="text-[9px] font-bold">Code</span>
            </button>
            <button onclick="switchTab('expenses')" class="nav-btn flex flex-col items-center gap-1 p-2 rounded-xl transition-all w-16 text-gray-400" data-tab="expenses">
                <i class="ph ph-wallet text-2xl mb-0.5"></i>
                <span class="text-[9px] font-bold">Wallet</span>
            </button>
        </div>
    </nav>

    <!-- MODAL (Universal) -->
    <div id="input-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl p-6 transform transition-transform duration-300 translate-y-full" id="modal-content">
            <div class="w-12 h-1 bg-gray-200 rounded-full mx-auto mb-6"></div>
            
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800">New Entry</h3>
                <span id="mode-indicator" class="text-xs font-bold text-brand-600 bg-brand-100 px-2 py-1 rounded-md hidden">EDIT MODE</span>
            </div>
            
            <div id="modal-form-area" class="space-y-4">
                <input type="text" id="input-title" placeholder="Judul..." class="w-full bg-gray-50 p-4 rounded-xl border border-gray-100 focus:outline-none focus:ring-2 focus:ring-brand-500 font-bold text-lg">
                
                <textarea id="input-body" placeholder="Tulis sesuatu... (Ketik '1. ' lalu Enter untuk list otomatis)" class="w-full bg-gray-50 p-4 rounded-xl border border-gray-100 focus:outline-none focus:ring-2 focus:ring-brand-500 h-48 resize-none hidden"></textarea>
                
                <div id="input-expense-area" class="hidden">
                     <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold">Rp</span>
                        <input type="number" id="input-price" placeholder="0" class="w-full bg-gray-50 p-4 pl-12 rounded-xl border border-gray-100 focus:outline-none focus:ring-2 focus:ring-brand-500 font-mono text-lg">
                    </div>
                </div>

                <button onclick="saveItem()" id="btn-save" class="w-full bg-brand-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-brand-200 active:scale-[0.98] transition-transform">
                    Simpan
                </button>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- State Management ---
        let appData = {
            notes: [],
            codes: [],
            expenses: []
        };
        let currentType = 'note';
        let editingIndex = null;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Service Worker Registration dengan update handling
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                .then(registration => {
                    console.log('SW Registered:', registration.scope);
                })
                .catch(err => console.log('SW Fail:', err));
            }

            // Network Status Listeners (Fitur Offline Baru)
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            updateOnlineStatus(); // Cek status awal

            const saved = localStorage.getItem('meNotePremiumData');
            if (saved) {
                appData = JSON.parse(saved);
            }
            renderAll();
            setupAutoNumbering();

            setTimeout(() => {
                const landing = document.getElementById('landing-screen');
                const app = document.getElementById('app-container');
                landing.classList.add('fade-out');
                app.classList.remove('opacity-0');
                setTimeout(() => landing.remove(), 800);
            }, 2500);
        });

        // --- Logic Status Online/Offline ---
        function updateOnlineStatus() {
            const badge = document.getElementById('offline-badge');
            if (!navigator.onLine) {
                badge.classList.add('show');
                // Optional: Ubah tema sedikit agar user sadar
                document.body.classList.add('grayscale-[0.5]');
            } else {
                badge.classList.remove('show');
                document.body.classList.remove('grayscale-[0.5]');
            }
        }

        // --- Logic Auto Numbering (Fitur Baru) ---
        function setupAutoNumbering() {
            const textarea = document.getElementById('input-body');
            
            textarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    const cursorPosition = this.selectionStart;
                    const textBeforeCursor = this.value.substring(0, cursorPosition);
                    const textAfterCursor = this.value.substring(cursorPosition);
                    
                    // Ambil baris terakhir sebelum kursor
                    const lastLineIndex = textBeforeCursor.lastIndexOf('\n');
                    const currentLine = textBeforeCursor.substring(lastLineIndex + 1);

                    // Cek pola angka (contoh: "1. ")
                    const regex = /^(\d+)\.\s/;
                    const match = currentLine.match(regex);

                    if (match) {
                        e.preventDefault(); // Mencegah enter biasa
                        const currentNumber = parseInt(match[1]);
                        const nextNumber = currentNumber + 1;
                        const insertion = `\n${nextNumber}. `;
                        
                        // Masukkan angka baru
                        this.value = textBeforeCursor + insertion + textAfterCursor;
                        
                        // Pindahkan kursor ke setelah angka baru
                        this.selectionStart = this.selectionEnd = cursorPosition + insertion.length;
                    }
                }
            });
        }

        function saveData() {
            localStorage.setItem('meNotePremiumData', JSON.stringify(appData));
            renderAll();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                const isActive = btn.dataset.tab === tabName;
                btn.className = `nav-btn flex flex-col items-center gap-1 p-2 rounded-xl transition-all w-16 ${isActive ? 'text-brand-600 scale-110' : 'text-gray-400'}`;
            });

            const titles = { 'notes': 'Catatan', 'code': 'Code Snippets', 'expenses': 'Keuangan' };
            document.getElementById('header-title').innerText = titles[tabName];

            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${tabName}`).classList.remove('hidden');
        }

        // --- Rendering ---
        function renderAll() {
            renderNotes();
            renderCodes();
            renderExpenses();
        }

        function renderNotes() {
            const list = document.getElementById('notes-list');
            list.innerHTML = '';
            appData.notes.forEach((note, index) => {
                list.innerHTML += `
                    <div onclick="openModal('note', ${index})" class="bg-white p-4 rounded-2xl border border-gray-50 shadow-sm relative group cursor-pointer active:bg-gray-50 transition">
                         <button onclick="event.stopPropagation(); deleteItem('notes', ${index})" class="absolute top-4 right-4 text-gray-300 hover:text-red-500 transition"><i class="ph ph-x-circle text-xl"></i></button>
                        <h4 class="font-bold text-gray-800 mb-1">${note.title}</h4>
                        <p class="text-sm text-gray-500 line-clamp-2 whitespace-pre-wrap">${escapeHtml(note.body)}</p>
                        <span class="text-[10px] text-gray-300 mt-2 block">${new Date(note.date).toLocaleDateString('id-ID')}</span>
                    </div>
                `;
            });
        }

        function renderCodes() {
            const list = document.getElementById('code-list');
            list.innerHTML = '';
            appData.codes.forEach((code, index) => {
                list.innerHTML += `
                    <div onclick="openModal('code', ${index})" class="bg-gray-900 p-4 rounded-2xl shadow-md border border-gray-800 relative group overflow-hidden cursor-pointer active:scale-[0.99] transition">
                        <button onclick="event.stopPropagation(); deleteItem('codes', ${index})" class="absolute top-4 right-4 text-gray-600 hover:text-red-400 transition z-10"><i class="ph ph-trash text-lg"></i></button>
                        <div class="flex items-center gap-2 mb-3 border-b border-gray-800 pb-2">
                            <div class="w-3 h-3 rounded-full bg-red-500"></div>
                            <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-xs text-gray-500 font-mono ml-2">${code.title}</span>
                        </div>
                        <pre class="font-mono text-xs text-brand-300 overflow-x-auto whitespace-pre-wrap"><code>${escapeHtml(code.body)}</code></pre>
                    </div>
                `;
            });
        }

        function renderExpenses() {
            const list = document.getElementById('expense-list');
            list.innerHTML = '';
            let total = 0;
            appData.expenses.forEach((item, index) => {
                total += parseInt(item.price);
                list.innerHTML += `
                    <div onclick="openModal('expense', ${index})" class="flex justify-between items-center bg-white p-3 rounded-xl border border-gray-50 cursor-pointer active:bg-gray-50">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center text-xs">
                                <i class="ph ph-shopping-bag"></i>
                            </div>
                            <span class="text-sm font-medium text-gray-700">${item.title}</span>
                        </div>
                        <div class="flex items-center gap-3">
                             <span class="text-sm font-bold text-gray-900">Rp ${parseInt(item.price).toLocaleString('id-ID')}</span>
                             <button onclick="event.stopPropagation(); deleteItem('expenses', ${index})" class="text-gray-300 hover:text-red-500"><i class="ph ph-trash"></i></button>
                        </div>
                    </div>
                `;
            });
            document.getElementById('total-expense').innerText = `Rp ${total.toLocaleString('id-ID')}`;
        }

        // --- CRUD Logic (Updated for Edit) ---
        function openModal(type, index = null) {
            currentType = type;
            editingIndex = index; // Set index global
            
            const modal = document.getElementById('input-modal');
            const content = document.getElementById('modal-content');
            const titleInput = document.getElementById('input-title');
            const bodyInput = document.getElementById('input-body');
            const priceArea = document.getElementById('input-expense-area');
            const priceInput = document.getElementById('input-price');
            const saveBtn = document.getElementById('btn-save');
            const modeIndicator = document.getElementById('mode-indicator');

            // Reset UI Default
            titleInput.value = '';
            bodyInput.value = '';
            priceInput.value = '';
            
            // Cek jika ini mode Edit
            if (index !== null) {
                modeIndicator.classList.remove('hidden');
                saveBtn.innerText = 'Perbarui';
                const data = appData[type === 'note' ? 'notes' : type === 'code' ? 'codes' : 'expenses'][index];
                
                titleInput.value = data.title;
                if(data.body) bodyInput.value = data.body;
                if(data.price) priceInput.value = data.price;
            } else {
                modeIndicator.classList.add('hidden');
                saveBtn.innerText = 'Simpan';
            }

            // Atur Tampilan Input berdasarkan tipe
            if (type === 'note') {
                document.getElementById('modal-title').innerText = index !== null ? 'Edit Catatan' : 'Tulis Catatan';
                titleInput.placeholder = "Judul Catatan";
                bodyInput.classList.remove('hidden', 'font-mono', 'bg-gray-900', 'text-white');
                priceArea.classList.add('hidden');
            } else if (type === 'code') {
                document.getElementById('modal-title').innerText = index !== null ? 'Edit Kode' : 'Simpan Kode';
                titleInput.placeholder = "Nama File / Bahasa";
                bodyInput.classList.remove('hidden');
                bodyInput.classList.add('font-mono', 'bg-gray-900', 'text-white');
                bodyInput.placeholder = "Tempel kodemu disini...";
                priceArea.classList.add('hidden');
            } else if (type === 'expense') {
                document.getElementById('modal-title').innerText = index !== null ? 'Edit Pengeluaran' : 'Catat Pengeluaran';
                titleInput.placeholder = "Nama Barang";
                bodyInput.classList.add('hidden');
                priceArea.classList.remove('hidden');
            }

            modal.classList.remove('hidden');
            setTimeout(() => content.classList.remove('translate-y-full'), 10);
        }

        function closeModal() {
            const modal = document.getElementById('input-modal');
            const content = document.getElementById('modal-content');
            content.classList.add('translate-y-full');
            setTimeout(() => {
                modal.classList.add('hidden');
                editingIndex = null; // Reset index edit
            }, 300);
        }

        function saveItem() {
            const title = document.getElementById('input-title').value;
            const body = document.getElementById('input-body').value;
            const price = document.getElementById('input-price').value;

            if (!title) return alert('Mohon isi judul!');

            const newData = { title, date: new Date() };
            if (currentType === 'expense') {
                if (!price) return alert('Mohon isi harga!');
                newData.price = price;
            } else {
                newData.body = body;
            }

            const category = currentType === 'note' ? 'notes' : currentType === 'code' ? 'codes' : 'expenses';

            if (editingIndex !== null) {
                // Logic Update/Edit
                appData[category][editingIndex] = { ...appData[category][editingIndex], ...newData };
            } else {
                // Logic Create New (Add to top)
                appData[category].unshift(newData);
            }

            saveData();
            closeModal();
        }

        function deleteItem(category, index) {
            if(confirm('Hapus item ini?')) {
                appData[category].splice(index, 1);
                saveData();
            }
        }

        function resetExpenses() {
             if(confirm('Reset semua data keuangan?')) {
                appData.expenses = [];
                saveData();
            }
        }

        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
